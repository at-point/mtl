#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# Update npm
npm update --verbose

# Cleanup
echo " * Cleaning up vendor/assets..."
[ -d vendor/assets ] && rm -rf vendor/assets || true
mkdir -p vendor/assets/stylesheets
mkdir -p vendor/assets/javascripts

# Copy SASS
echo " * Copy node_modules/materialize-css/sass..."
cp -r node_modules/materialize-css/sass/components vendor/assets/stylesheets/materialize

# Copy JS
echo " * Copy node_modules/materialize-css/js..."
cp -r node_modules/materialize-css/js vendor/assets/javascripts/materialize
[ -f vendor/assets/javascripts/materialize/materialize.js ] && rm vendor/assets/javascripts/materialize/materialize.js || true

# Copy fonts
echo " * Copy node_modules/materialize-css/fonts..."
cp -r node_modules/materialize-css/fonts vendor/assets/fonts

echo " * Cleanup file permissions -x flags?!"
find vendor/assets -type f -print0 | xargs -0 chmod gou-x

vers=$(node -e 'var p=require("./node_modules/materialize-css/package.json");console.log(p.version)')

echo
echo " NEXT STEPS:"
echo " [ ] Commit changes to vendor/assets via git"
echo " [ ] Copy or update the following files:"
echo "     - app/assets/javascripts/materialize.js"
echo "     - lib/generators/materializer/templates/materialize.scss"
echo "     - lib/generators/materializer/templates/_color.scss"
echo "     - lib/generators/materializer/templates/_variables.scss"
echo "  ~> Compare against node_modules/materialize-css/sass!"
echo " [ ] Update lib/materializer/version#MATERIALIZE_VERSION => ${vers}"
